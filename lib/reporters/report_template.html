<!doctype html>
<html>
<head>
    <title>CSS Checker Report</title>
    <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .bar rect {
            fill: steelblue;
            shape-rendering: crispEdges;
        }

        .bar text {
            fill: #fff;
        }

        .axis path, .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        text {
            fill: #000;
            font-size: 10px;
        }
    </style>
</head>
</html>
<body>
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h1>
                CSS Checker Report
            </h1>
        </div>
    </div>
    <div class="row">
        <div class="col-md-4">
            {{classes.count}} classes
        </div>
        <div class="col-md-8">
            <div class="chart-classes-definitions-distribution"></div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-4">
            {{classes.usedCount}} used
            {{classes.unusedCount}} unused ({{classes.unusedPercentage}}%)
            {{classes.avgUsage}} average usage per class
        </div>
        <div class="col-md-8">
            <div class="chart-classes-usages-distribution"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            {{selectors.count}} selectors
            {{selectors.avgLength}} average selector length
        </div>
        <div class="col-md-8">
            <div class="chart-selectors-length-distribution"></div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <!-- Nav tabs -->
            <ul class="nav nav-tabs" role="tablist">
                {{#each report.types}}
                    <li><a href="#{{@key}}-content" role="tab" data-toggle="tab">{{@key}}</a></li>
                {{/each}}
            </ul>

            <!-- Tab panes -->
            <div class="tab-content">
                {{#each report.types}}
                    <div class="tab-pane" id="{{@key}}-content">
                        {{#each this}}
                            <h4>{{@key}}</h4>
                            <ul>
                                {{#each this}}
                                    <li>{{this.message}}</li>
                                {{/each}}
                            </ul>
                        {{/each}}
                    </div>
                {{/each}}
            </div>
        </div>
    </div>
</div>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script>
    var stats = {{{stringifiedJSON}}};

    var DistributionChart = function (cfg) {
        var self = this;

        this.node = document.querySelector(cfg.nodeSelector);

        this.margin = {
            top : 10,
            right : 10,
            bottom : 50,
            left : 50
        };

        this.width = this.node.clientWidth - this.margin.left - this.margin.right;
        this.height = 200 - this.margin.top - this.margin.bottom;

        this.occurences = {};

        cfg.values.forEach(function (d) {
            if (self.occurences.hasOwnProperty(d)) {
                self.occurences[d] += 1;
            } else {
                self.occurences[d] = 1;
            }
        });

        this.data = [];

        for (var key in self.occurences) {
            this.data.push({
                extent : +key,
                occurences : +self.occurences[key]
            });
        }

        this.x = d3.scale.log()
                .domain([0.9, d3.max(this.data, function (d) {
                    return d.extent;
                })]).range([0, this.width]);

        this.y = d3.scale.log()
                .domain([0.9, d3.max(this.data, function (d) {
                    return d.occurences;
                })])
                .range([this.height, 0]);

        this.xAxis = d3.svg.axis()
                .scale(self.x)
                .ticks(10, "d")
                .orient("bottom");

        this.yAxis = d3.svg.axis()
                .scale(self.y)
                .ticks(5, "d")
                .orient("left");

        this.wrapper = d3.select(this.node).append("svg")
                .attr("width", this.width + this.margin.left + this.margin.right)
                .attr("height", this.height + this.margin.top + this.margin.bottom);

        this.svg = this.wrapper.append("g")
                .attr("transform", "translate(" + this.margin.left + "," + this.margin.top + ")");

        this.point = self.svg.selectAll(".point")
                .data(self.data)
                .enter()
                .append("circle")
                .attr("class", "point")
                .attr("cx", function (d) {
                    return self.x(d.extent);
                })
                .attr("cy", function (d) {
                    return self.y(d.occurences);
                })
                .attr("r", 1)
                .on("mouseover", function (d) {
                    console.log(d.occurences + " classes were used " + d.extent + " times.");
                });

        this.svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + self.height + ")")
                .call(self.xAxis);

        this.svg.append("g")
                .attr("class", "y axis")
                .attr("transform", "translate(0,0)")
                .call(self.yAxis);

        this.svg.append("text")
                .attr("class", "x label")
                .attr("text-anchor", "end")
                .attr("x", self.width)
                .attr("y", self.height + 40)
                .text(cfg.xLabel);

        this.svg.append("text")
                .attr("class", "y label")
                .attr("text-anchor", "end")
                .attr("x", 0)
                .attr("y", -50)
                .attr("dy", ".75em")
                .attr("transform", "rotate(-90)")
                .text(cfg.yLabel);

        this.resize = function () {
            self.width = document.querySelector(cfg.nodeSelector).clientWidth - self.margin.left - self.margin.right;
            self.height = 300 - self.margin.top - self.margin.bottom;

            self.x.range([0, self.width]);
            self.y.range([self.height, 0]);

            self.wrapper.attr("width", self.width + self.margin.left + self.margin.right)
                    .attr("height", self.height + self.margin.top + self.margin.bottom);
            self.wrapper.select('.x.axis').call(self.xAxis);
            self.wrapper.select('.y.axis').call(self.yAxis);
            self.wrapper.selectAll('.point')
                    .attr("cx", function (d) {
                        return self.x(d.extent);
                    })
                    .attr("cy", function (d) {
                        return self.y(d.occurences);
                    });
            self.wrapper.select('.x.label').attr('x', self.width);
        };

        return this;
    };

    var charts = [];

    charts.push(new DistributionChart({
        nodeSelector : '.chart-classes-usages-distribution',
        values : stats.classes.usagesDistribution,
        xLabel : '# of class usages',
        yLabel : '# of unique classes'
    }));

    charts.push(new DistributionChart({
        nodeSelector : '.chart-classes-definitions-distribution',
        values : stats.classes.definitionsDistribution,
        xLabel : '# of class definitions',
        yLabel : '# of unique classes'
    }));

    charts.push(new DistributionChart({
        nodeSelector : '.chart-selectors-length-distribution',
        values : stats.selectors.lengthsDistribution,
        xLabel : 'Selector length',
        yLabel : '# of unique selectors'
    }));

    var timer;

    window.onresize = function () {
        if (timer) {
            window.clearTimeout(timer);
        }

        timer = window.setTimeout(function () {
            charts.forEach(function (c) {
                c.resize();
            });
        }, 100);
    };

</script>
</body>
